<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>وێنەنووسی دەنگی بەکاتی ڕاست</title>
  <!-- Inter + Kurdish font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body class="flex flex-col items-center justify-start min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100" style="direction: rtl; text-align: right; font-family: 'Inter', 'Noto Naskh Arabic', sans-serif;">

  <!-- Navbar -->
  <nav class="w-full bg-white dark:bg-gray-800 shadow-md">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="text-lg font-semibold text-gray-800 dark:text-gray-100">
        بەخێربێیت <span id="userNameDisplay"></span> | <span id="coinDisplay"></span>
      </div>
      <div class="flex items-center space-x-4">
        <button id="chargeBtn" class="text-gray-600 dark:text-gray-300 hover:text-green-500 transition" title="چونەدەرەوە">چونەدەرەوە</button>
        <button id="logoutBtn" class="flex items-center text-gray-600 dark:text-gray-300 hover:text-red-500 transition" title="چونەدەرەوە">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Recording Panel -->
  <div class="w-full flex flex-col items-center justify-center py-12" style="background: linear-gradient(180deg, #4BB0FF 0%, #2AA7FF 100%);">
    <div id="recordBtn" class="w-20 h-20 rounded-full bg-white bg-opacity-30 flex items-center justify-center cursor-pointer transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 14a3 3 0 003-3V5a3 3 0 10-6 0v6a3 3 0 003 3z" />
        <path d="M19 11a1 1 0 10-2 0 5 5 0 01-10 0 1 1 0 10-2 0 7 7 0 006 6.92V21h-3a1 1 0 000 2h8a1 1 0 000-2h-3v-3.08A7 7 0 0019 11z" />
      </svg>
    </div>
    <div class="flex items-center space-x-6 mt-6 text-white opacity-80">
      <button id="pauseBtn" class="focus:outline-none hover:opacity-80 transition" title="وەستاندن">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
        </svg>
      </button>
      <button id="deleteBtn" class="focus:outline-none hover:opacity-80 transition" title="سڕینەوە">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 3v1H4v2h16V4h-5V3H9zm-1 6v10h2V9H8zm4 0v10h2V9h-2zm4 0v10h2V9h-2z"/>
        </svg>
      </button>
    </div>
    <p class="mt-4 text-lg font-medium text-white opacity-90">قسە بکە...</p>
  </div>

  <!-- Editor Section -->
  <div class="w-full max-w-3xl bg-white dark:bg-gray-800 rounded-2xl shadow-lg mt-8 transition-colors">
    <!-- Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-700">
      <button id="tab-audio" class="flex-1 py-3 px-4 text-center font-medium bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">فایلی دەنگی</button>
      <button id="tab-lang" class="flex-1 py-3 px-4 text-center font-medium bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400">زمانی نووسین</button>
    </div>
    <!-- Audio Upload -->
    <div id="content-audio" class="p-4 border-b border-gray-200 dark:border-gray-700">
      <input type="file" id="audioFileInput" accept="audio/*" class="hidden" />
      <button id="uploadAudioBtn" class="w-full py-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-400 hover:border-gray-400 transition">بارکردنی فایلی دەنگی</button>
    </div>
    <!-- Language Selection -->
    <div id="content-lang" class="hidden p-4 border-b border-gray-200 dark:border-gray-700">
      <label for="typingLang" class="block mb-2 text-gray-700 dark:text-gray-200">هەڵبژاردنی زمانی نووسین:</label>
      <select id="typingLang" class="w-full p-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-gray-100">
        <option value="ku">کوردی - سۆرانی</option>
        <option value="fa">فارسی</option>
        <option value="en">English</option>
      </select>
    </div>
    <!-- Toolbar + Custom Buttons -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
      <div id="toolbar"></div>
      <div class="flex space-x-4">
        <button id="exportWordBtn" class="focus:outline-none hover:opacity-80 transition" title="هەڵگرتنی وۆرد">...
        </button>
        <button id="copyBtn" class="focus:outline-none hover:opacity-80 transition" title="کۆپی کردن">...
        </button>
        <button id="clearBtn" class="focus:outline-none hover:opacity-80 transition" title="پاک کردن">...
        </button>
      </div>
    </div>
    <!-- Quill Editor -->
    <div id="editor" class="overflow-y-auto p-4" style="height:20rem;"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@latest/dist/bundle.min.js"></script>
  <script>
    // User & Wallet Initialization
    const currentUser = localStorage.getItem('currentUser') || '';
    let usersDB = JSON.parse(localStorage.getItem('users') || '[]');
    function saveUsers() { localStorage.setItem('users', JSON.stringify(usersDB)); }
    const currentUserObj = usersDB.find(x => x.user === currentUser);
    if (!currentUserObj) window.location.href = 'login.html';
    document.getElementById('userNameDisplay').textContent = currentUser;
    document.getElementById('coinDisplay').textContent = `: ${currentUserObj.coins}`;

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    });

    // Charge Wallet (1 Dinar = 10 coins)
    document.getElementById('chargeBtn').addEventListener('click', () => {
      let dinars = prompt('بڕی دینار بنووسە:');
      if (dinars != null) {
        let d = parseFloat(dinars);
        if (isNaN(d) || d <= 0) { alert('بڕێکی دروست بنووسە'); return; }
        let coinsToAdd = Math.floor(d * 10);
        currentUserObj.coins += coinsToAdd;
        saveUsers();
        document.getElementById('coinDisplay').textContent = `باڵانس: ${currentUserObj.coins}`;
        alert(`جێب بە ${coinsToAdd} سکه شارژ کرا`);
      }
    });

    // Quill Editor Init
    const quill = new Quill('#editor', {
      theme: 'snow', modules: { toolbar: [ [{ header: [1, 2, false] }], ['bold','italic','underline'], [{ size: ['small', false,'large','huge'] }], [{ color: [] }], ['link','code-block'] ] }, placeholder: 'دەقی خۆت لێرە بنووسە...'
    });

    // ASR Config
    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/';
    ort.env.wasm.numThreads = 1;
    const sampleRate = 16000;

    // VAD & Recording Logic
    let isRecording = false; let vadInstance;
    const recordBtn = document.getElementById('recordBtn');
    recordBtn.addEventListener('click', async () => {
      if (!isRecording) {
        isRecording = true; quill.setText('');
        vadInstance = await vad.MicVAD.new({
          onSpeechStart: () => recordBtn.classList.add('bg-red-500'),
          onSpeechEnd: async float32Audio => {
            recordBtn.classList.remove('bg-red-500');
            const seconds = Math.ceil(float32Audio.length / sampleRate);
            if (currentUserObj.coins < seconds) { alert('باڵانس کەمە! تکایە جێب شارژ بکە'); return; }
            currentUserObj.coins -= seconds; saveUsers();
            document.getElementById('coinDisplay').textContent = `باڵانس: ${currentUserObj.coins}`;
            const wav = encodeWAV(float32Audio); const fd = new FormData(); fd.append('file', wav, 'chunk.wav');
            try { const res = await fetch('https://asr.asosoft.com/audio-files',{ method:'POST', body:fd }); const js = await res.json(); quill.insertText(quill.getLength()-1,(js.text||js.transcription||'')+' '); }
            catch { quill.insertText(quill.getLength()-1,'[Error transcribing] '); }
          }
        }); vadInstance.start();
      } else { isRecording = false; recordBtn.classList.remove('bg-red-500'); vadInstance.stop(); }
    });
    document.getElementById('pauseBtn').addEventListener('click', () => vadInstance && vadInstance.pause());
    document.getElementById('deleteBtn').addEventListener('click', () => { vadInstance && vadInstance.reset(); quill.setText(''); });

    // Export, Copy, Clear (unchanged)
    document.getElementById('exportWordBtn').addEventListener('click', () => {
      const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>";
      const footer = '</body></html>';
      const source = header + quill.root.innerHTML + footer;
      const blob = new Blob([source], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'document.doc'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('copyBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(quill.getText()); alert('نەوسینی دەقی کۆپی کرا'); } catch { alert('هەڵە لە کۆپی کردن'); }
    });
    document.getElementById('clearBtn').addEventListener('click', () => quill.setText(''));

    // Tab Logic
    function selectTab(name) { const a = document.getElementById('content-audio'), l = document.getElementById('content-lang'), ta = document.getElementById('tab-audio'), tl = document.getElementById('tab-lang');
      if (name==='audio'){a.classList.remove('hidden');l.classList.add('hidden');ta.classList.replace('bg-gray-100','bg-white');tl.classList.replace('bg-white','bg-gray-100');}
      else {l.classList.remove('hidden');a.classList.add('hidden');tl.classList.replace('bg-gray-100','bg-white');ta.classList.replace('bg-white','bg-gray-100');}
    }
    selectTab('audio');
    document.getElementById('tab-audio').addEventListener('click', () => selectTab('audio'));
    document.getElementById('tab-lang').addEventListener('click', () => selectTab('lang'));

    // Audio Upload + Coin Deduction
    const fileInput = document.getElementById('audioFileInput'), uploadBtn = document.getElementById('uploadAudioBtn');
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0]; if (!file) return;
      const url = URL.createObjectURL(file);
      const tmp = new Audio(); tmp.src = url;
      tmp.onloadedmetadata = async () => {
        const dur = Math.ceil(tmp.duration);
        if (currentUserObj.coins < dur) { alert('باڵانس کەمە! تکایە جێب شارژ بکە'); URL.revokeObjectURL(url); return; }
        currentUserObj.coins -= dur; saveUsers(); document.getElementById('coinDisplay').textContent = `باڵانس: ${currentUserObj.coins}`;
        uploadBtn.textContent = 'لەبارکردندا...';
        const fd = new FormData(); fd.append('file', file);
        try { const res = await fetch('https://asr.asosoft.com/audio-files',{ method:'POST', body:fd }); const js = await res.json(); quill.setText(''); quill.insertText(0, js.text||js.transcription||''); }
        catch { quill.insertText(0,'[هەڵە لە بارکردن]'); }
        finally { uploadBtn.textContent='بارکردنی فایلی دەنگی'; URL.revokeObjectURL(url); }
      };
    });

    // WAV Encoder
    function encodeWAV(samples) {
      const numCh = 1, bytesPerSample = 2, sampleRate = 16000;
      const dataSize = samples.length * bytesPerSample, buffer = new ArrayBuffer(44 + dataSize);
      const view = new DataView(buffer);
      function writeStr(o, s) { for (let i=0; i<s.length; i++) view.setUint8(o+i,s.charCodeAt(i)); }
      writeStr(0,'RIFF'); view.setUint32(4,36+dataSize,true);
      writeStr(8,'WAVE'); writeStr(12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true);
      view.setUint16(22,numCh,true); view.setUint32(24,sampleRate,true);
      view.setUint32(28,sampleRate*numCh*bytesPerSample,true);
      view.setUint16(32,numCh*bytesPerSample,true); view.setUint16(34,bytesPerSample*8,true);
      writeStr(36,'data'); view.setUint32(40,dataSize,true);
      let offset=44;
      for (let i=0; i<samples.length; i++) {
        const s = Math.max(-1,Math.min(1,samples[i]));
        view.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF,true);
        offset += 2;
      }
      return new Blob([view], { type: 'audio/wav' });
    }
  </script>
</body>
</html>
