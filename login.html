<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>وێنەنووسی دەنگی بەکاتی ڕاست – Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100" style="direction: rtl; font-family:'Inter','Noto Naskh Arabic',sans-serif;">

  <div id="authSection" class="w-full max-w-sm p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
    <h2 class="text-xl font-semibold mb-4 text-center">چۆنەژوورەوە / تۆمارکردن</h2>
    <div class="flex mb-4">
      <button id="loginTab" class="flex-1 py-2 bg-blue-500 text-white rounded-l-lg">چۆنەژوورەوە</button>
      <button id="registerTab" class="flex-1 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-r-lg">تۆمارکردن</button>
    </div>
    <p id="authMsg" class="mb-4 text-center"></p>

    <form id="loginForm" class="space-y-4">
      <div>
        <label for="loginUser" class="block mb-1">ناوی بەکارهێنەر:</label>
        <input id="loginUser" type="text" class="w-full p-2 border rounded" required />
      </div>
      <div>
        <label for="loginPass" class="block mb-1">ووشەی نهێنی:</label>
        <input id="loginPass" type="password" class="w-full p-2 border rounded" required />
      </div>
      <button type="submit" class="w-full py-2 bg-blue-500 text-white rounded">چۆنەژوورەوە</button>
    </form>

    <form id="registerForm" class="hidden space-y-4">
      <div>
        <label for="regUser" class="block mb-1">ناوی بەکارهێنەر:</label>
        <input id="regUser" type="text" class="w-full p-2 border rounded" required />
      </div>
      <div>
        <label for="regPass" class="block mb-1">ووشەی نهێنی:</label>
        <input id="regPass" type="password" class="w-full p-2 border rounded" required />
      </div>
      <button type="submit" class="w-full py-2 bg-green-500 text-white rounded">تۆمارکردن</button>
    </form>
  </div>

  <script>
    const authMsg = document.getElementById('authMsg');

    function showMsg(text, isError = true) {
      authMsg.textContent = text;
      authMsg.classList.toggle('text-red-500', isError);
      authMsg.classList.toggle('text-green-500', !isError);
    }

    // Simple wrapper to do fetch + error handling
    async function safeFetch(url, options) {
      try {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          // HTTP-level error (4xx, 5xx)
          throw new Error(data.message || `HTTP ${res.status}`);
        }
        return data;
      } catch (err) {
        if (err.name === 'TypeError') {
          // Likely network error or CORS blockage
          throw new Error('Connection failed. Please check your network or server status.');
        }
        throw err;
      }
    }

    // Tab switching
    document.getElementById('loginTab').onclick = () => {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      showMsg('');
    };
    document.getElementById('registerTab').onclick = () => {
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
      showMsg('');
    };

    // Determine the base URL dynamically
    const API_BASE = `${window.location.protocol}//${window.location.host}/api`;

    // Register handler
    document.getElementById('registerForm').onsubmit = async e => {
      e.preventDefault();
      const user = document.getElementById('regUser').value.trim();
      const pass = document.getElementById('regPass').value;
      try {
        const data = await safeFetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, pass })
        });
        showMsg(data.message, false);
        e.target.reset();
      } catch (err) {
        showMsg(err.message);
      }
    };

    // Login handler
    document.getElementById('loginForm').onsubmit = async e => {
      e.preventDefault();
      const user = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value;
      try {
        await safeFetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, pass })
        });
        // on success, redirect
        window.location.href = 'asrs.html';
      } catch (err) {
        showMsg(err.message);
      }
    };
  </script>
</body>
</html>
